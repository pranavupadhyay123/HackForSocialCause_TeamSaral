<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARAL (Smart Alert & Resilient Aid Layer) - Citizen App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Face API -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        .animate-blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Custom Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }
    </style>
    <!-- DEBUG OVERLAY -->
    <div id="debug-console"
        style="display:none; position:fixed; top:0; left:0; width:100%; background:rgba(0,0,0,0.8); color:lime; font-family:monospace; z-index:9999; padding:10px; pointer-events:none; font-size:12px;">
    </div>
    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.style.display = 'block';
            consoleDiv.innerHTML += `<div>‚ùå ${msg} (Line ${lineNo})</div>`;
            return false;
        };
        window.addEventListener('unhandledrejection', event => {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.style.display = 'block';
            consoleDiv.innerHTML += `<div>‚ö†Ô∏è Promise Rejection: ${event.reason}</div>`;
        });
        console.log("Debug Mode Enabled");
    </script>
</head>

<body class="bg-gray-100 text-gray-800 font-sans pb-20">

    <!-- DISASTER OVERLAY -->
    <div id="user-disaster-alert"
        class="hidden fixed inset-0 z-[2000] flex flex-col items-center justify-center text-white p-6 text-center bg-red-600/95 backdrop-blur-sm">
        <i class="fas fa-radiation text-7xl mb-4 animate-spin-slow text-yellow-300"></i>
        <h1 class="text-4xl font-black uppercase mb-2 tracking-wider">EMERGENCY</h1>
        <h2 id="user-alert-type" class="text-2xl font-bold mb-4 bg-black/30 px-4 py-2 rounded">ALERT RECEIVED</h2>
        <p id="user-alert-msg" class="text-lg mb-8">Seek shelter immediately. Follow official instructions.</p>
        <button onclick="dismissUserAlert()"
            class="bg-white text-red-700 px-8 py-3 rounded-full font-bold text-lg shadow-xl hover:scale-105 transition">
            I AM SAFE
        </button>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-lg">
                    <i class="fas fa-shield-virus text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide" data-i18n="app_name">SARAL (Smart Alert & Resilient Aid
                        Layer)</h1>
                    <p class="text-[10px] text-blue-200 uppercase" data-i18n="app_tagline">Smart Alert & Resilient Aid
                        Layer</p>
                </div>
            </div>
            <div class="text-right flex items-center gap-3">
                <select onchange="changeLanguage(this.value)"
                    class="bg-blue-800 text-white text-xs p-1 rounded border border-blue-600 focus:outline-none">
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                    <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                </select>
                <p class="text-xs font-mono bg-blue-800 px-2 py-1 rounded" id="user-id-display">ID: ...</p>
            </div>
        </div>
    </nav>

    <!-- STATUS BANNER -->
    <div class="bg-green-600 text-white p-3 text-center font-bold text-sm shadow-md" id="status-banner">
        <i class="fas fa-check-circle"></i> STATUS: SAFE
    </div>

    <div class="p-4 max-w-md lg:max-w-7xl mx-auto lg:grid lg:grid-cols-12 lg:gap-6 space-y-4 lg:space-y-0">

        <!-- LEFT COLUMN: STATUS & CONTROLS -->
        <div class="lg:col-span-3 space-y-4">
            <!-- OFFLINE MESH TOGGLE -->
            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-gray-100 p-2 rounded-full text-gray-600" id="mesh-icon">
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm text-gray-700" data-i18n="conn_mode">Connection Mode</h3>
                        <p class="text-xs text-gray-500" id="mesh-status" data-i18n="conn_online">Online (Internet)</p>
                    </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" class="sr-only peer" onchange="toggleMeshMode(this)">
                    <div
                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                    </div>
                </label>
            </div>

            <!-- HEALTH TRIAGE -->
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <h3 class="font-bold text-blue-800 mb-2"><i class="fas fa-user-md"></i> <span
                        data-i18n="triage_title">Health Triage</span></h3>
                <div class="flex gap-2">
                    <button onclick="reportHealth('Minor')"
                        class="flex-1 bg-green-100 text-green-800 py-2 rounded text-xs font-bold hover:bg-green-200">üü¢
                        <span data-i18n="btn_minor">Minor</span></button>
                    <button onclick="reportHealth('Moderate')"
                        class="flex-1 bg-yellow-100 text-yellow-800 py-2 rounded text-xs font-bold hover:bg-yellow-200">üü°
                        <span data-i18n="btn_moderate">Moderate</span></button>
                    <button onclick="reportHealth('Critical')"
                        class="flex-1 bg-red-100 text-red-800 py-2 rounded text-xs font-bold hover:bg-red-200">üî¥
                        <span data-i18n="btn_critical">Critical</span></button>
                </div>
            </div>

            <!-- PREPAREDNESS -->
            <button onclick="document.getElementById('checklist-modal').classList.remove('hidden')"
                class="w-full bg-gray-100 text-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 flex items-center gap-3 hover:bg-gray-200">
                <i class="fas fa-clipboard-check text-2xl text-gray-600"></i>
                <div class="text-left">
                    <span class="font-bold text-sm block" data-i18n="checklist_title">Preparedness Checklist</span>
                    <span class="text-xs text-gray-500" data-i18n="checklist_desc">Are you ready?</span>
                </div>
            </button>
        </div>

        <!-- CENTER COLUMN: MAP & SOS -->
        <div class="lg:col-span-6 space-y-4">
            <!-- SAFE ROUTE MAP -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 h-[400px] flex flex-col">
                <h3 class="font-bold text-gray-700 mb-2 flex justify-between shrink-0">
                    <span><i class="fas fa-map-marked-alt"></i> <span data-i18n="safe_route_title">Safe
                            Route</span></span>
                    <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500" data-i18n="gps_active">GPS
                        Active</span>
                </h3>
                <div id="map" class="rounded bg-gray-100 mb-2 flex-grow h-full"></div>
                <button onclick="findSafeZone()"
                    class="w-full bg-blue-600 text-white py-3 rounded font-bold text-sm shadow hover:bg-blue-700 shrink-0"
                    data-i18n="nav_btn">
                    NAVIGATE TO SAFE ZONE
                </button>
            </div>

            <!-- SOS BUTTON -->
            <button onclick="sendSOS()"
                class="w-full bg-red-600 text-white p-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-4 hover:bg-red-700">
                <i class="fas fa-broadcast-tower text-3xl animate-pulse"></i>
                <div class="text-left">
                    <h2 class="text-xl font-black" data-i18n="sos_full_title">SOS EMERGENCY</h2>
                    <p class="text-xs text-red-100" data-i18n="sos_full_desc">Broadcast Distress Signal</p>
                </div>
            </button>
        </div>

        <!-- RIGHT COLUMN: ACTIONS -->
        <div class="lg:col-span-3 grid grid-cols-2 lg:grid-cols-1 gap-3 h-fit">
            <!-- REPORT DAMAGE -->
            <button onclick="document.getElementById('damage-modal').classList.remove('hidden')"
                class="bg-orange-100 text-orange-800 p-4 rounded-xl shadow-sm border border-orange-200 flex flex-col lg:flex-row items-center gap-3 hover:bg-orange-200">
                <i class="fas fa-house-damage text-2xl"></i>
                <span class="font-bold text-xs lg:text-sm" data-i18n="btn_damage">Report Damage</span>
            </button>

            <!-- MISSING PERSONS -->
            <button onclick="document.getElementById('lost-modal').classList.remove('hidden')"
                class="bg-purple-100 text-purple-800 p-4 rounded-xl shadow-sm border border-purple-200 flex flex-col lg:flex-row items-center gap-3 hover:bg-purple-200">
                <i class="fas fa-user-friends text-2xl"></i>
                <span class="font-bold text-xs lg:text-sm" data-i18n="btn_missing">Find People</span>
            </button>

            <!-- SCAN FACES (NEW) -->
            <button onclick="openScannerModal()"
                class="bg-pink-100 text-pink-800 p-4 rounded-xl shadow-sm border border-pink-200 flex flex-col lg:flex-row items-center gap-3 hover:bg-pink-200">
                <i class="fas fa-camera-retro text-2xl"></i>
                <span class="font-bold text-xs lg:text-sm">Scan Faces</span>
            </button>

            <!-- VOLUNTEER -->
            <button onclick="document.getElementById('volunteer-modal').classList.remove('hidden')"
                class="bg-teal-100 text-teal-800 p-4 rounded-xl shadow-sm border border-teal-200 flex flex-col lg:flex-row items-center gap-3 hover:bg-teal-200">
                <i class="fas fa-hands-helping text-2xl"></i>
                <span class="font-bold text-xs lg:text-sm" data-i18n="btn_volunteer">Volunteer</span>
            </button>
        </div>

    </div>

    <!-- DAMAGE REPORT MODAL -->
    <div id="damage-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-fade-in">
            <h2 class="text-xl font-bold mb-4 text-orange-700"><i class="fas fa-exclamation-triangle"></i> Report Damage
            </h2>
            <form onsubmit="submitDamageReport(event)" class="space-y-3">
                <select id="damage-type" class="w-full p-2 border rounded bg-gray-50 text-sm font-bold">
                    <option value="Road Blocked">üöß Road Blocked</option>
                    <option value="Building Collapse">üèö Building Collapse</option>
                    <option value="Power Failure">‚ö° Power Failure</option>
                    <option value="Flooding">üåä Flooding</option>
                </select>
                <textarea id="damage-desc" placeholder="Describe the situation..."
                    class="w-full p-2 border rounded bg-gray-50 text-sm h-20"></textarea>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('damage-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 rounded font-bold text-sm">Cancel</button>
                    <button type="submit"
                        class="flex-1 bg-orange-600 text-white py-2 rounded font-bold text-sm shadow">Submit
                        Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LOST & FOUND MODAL -->
    <div id="lost-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-purple-700"><i class="fas fa-search"></i> Lost & Found</h2>
                <div class="flex bg-gray-100 rounded p-1">
                    <button onclick="toggleLostTab('person')" id="tab-person"
                        class="px-3 py-1 rounded bg-purple-600 text-white text-xs font-bold transition">Person</button>
                    <button onclick="toggleLostTab('item')" id="tab-item"
                        class="px-3 py-1 rounded text-gray-500 text-xs font-bold transition hover:bg-gray-200">Item</button>
                </div>
            </div>

            <!-- Missing Person Form -->
            <form id="form-person" onsubmit="submitLostReport(event, 'person')" class="space-y-3">
                <input type="text" id="p-name" placeholder="Name of Person"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="p-age" placeholder="Age" class="p-2 border rounded bg-gray-50 text-sm"
                        required>
                    <select id="p-gender" class="p-2 border rounded bg-gray-50 text-sm">
                        <option>Male</option>
                        <option>Female</option>
                        <option>Child</option>
                    </select>
                </div>
                <input type="text" id="p-clothes" placeholder="Clothing Description"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>

                <div class="mb-2">
                    <label class="block text-xs font-bold mb-1">Upload Photo</label>
                    <input type="file" id="p-image" accept="image/*"
                        class="w-full border p-2 rounded text-xs bg-gray-50">
                </div>

                <input type="tel" id="p-contact" placeholder="Your Contact Number"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('lost-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 rounded font-bold text-sm">Cancel</button>
                    <button type="submit"
                        class="flex-1 bg-purple-600 text-white py-2 rounded font-bold text-sm shadow">Report
                        Missing</button>
                </div>
            </form>

            <!-- Lost Item Form -->
            <form id="form-item" onsubmit="submitLostReport(event, 'item')" class="hidden space-y-3">
                <select id="i-type" class="w-full p-2 border rounded bg-gray-50 text-sm">
                    <option>Wallet / ID</option>
                    <option>Mobile Phone</option>
                    <option>Bag / Luggage</option>
                    <option>Jewelry</option>
                </select>
                <input type="text" id="i-desc" placeholder="Item Description"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                <input type="text" id="i-loc" placeholder="Last Seen Location"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                <input type="tel" id="i-contact" placeholder="Your Contact Number"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('lost-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 rounded font-bold text-sm">Cancel</button>
                    <button type="submit"
                        class="flex-1 bg-gray-700 text-white py-2 rounded font-bold text-sm shadow">Report Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MEDICAL REPORT MODAL -->
    <div id="medical-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-fade-in">
            <h2 class="text-xl font-bold mb-4 text-blue-700"><i class="fas fa-heartbeat"></i> Medical Report</h2>
            <form onsubmit="submitMedicalReport(event)" class="space-y-3">
                <input type="hidden" id="med-severity">

                <div class="bg-gray-100 p-2 rounded text-center mb-2">
                    <span class="text-xs text-gray-500 uppercase font-bold">Severity Level</span>
                    <div id="med-severity-display" class="font-black text-lg uppercase">CRITICAL</div>
                </div>

                <label class="block text-sm font-bold text-gray-700">Injury Type</label>
                <select id="med-type" class="w-full p-2 border rounded bg-gray-50 text-sm">
                    <option value="Bleeding">ü©∏ Severe Bleeding</option>
                    <option value="Fracture">ü¶¥ Bone Fracture</option>
                    <option value="Burns">üî• Burns</option>
                    <option value="Breathing">ü´Å Breathing Difficulty</option>
                    <option value="Unconscious">üí§ Unconscious</option>
                    <option value="Chest Pain">üíî Chest Pain</option>
                    <option value="Other">‚ùì Other</option>
                </select>

                <label class="flex items-center gap-3 p-3 bg-red-50 border border-red-100 rounded cursor-pointer">
                    <input type="checkbox" id="med-conscious" class="w-5 h-5 accent-red-600">
                    <span class="text-sm font-bold text-red-800">Patient is Unconscious?</span>
                </label>

                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="document.getElementById('medical-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 rounded font-bold text-sm">Cancel</button>
                    <button type="submit"
                        class="flex-1 bg-blue-600 text-white py-2 rounded font-bold text-sm shadow">Send Alert</button>
                </div>
            </form>
        </div>
    </div>

    <!-- VOLUNTEER MODAL -->
    <div id="volunteer-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-teal-700"><i class="fas fa-hands-helping"></i> Community</h2>
                <div class="flex bg-gray-100 rounded p-1">
                    <button onclick="toggleVolTab('request')" id="tab-request"
                        class="px-3 py-1 rounded bg-teal-600 text-white text-xs font-bold transition">Request
                        Help</button>
                    <button onclick="toggleVolTab('join')" id="tab-join"
                        class="px-3 py-1 rounded text-gray-500 text-xs font-bold transition hover:bg-gray-200">Join</button>
                </div>
            </div>

            <!-- Request Help Form -->
            <form id="form-request" onsubmit="submitVolunteer(event, 'request')" class="space-y-3">
                <div class="p-3 bg-teal-50 rounded border border-teal-100 text-xs text-teal-800 mb-2">
                    Request non-emergency assistance from nearby volunteers.
                </div>
                <select id="req-type" class="w-full p-2 border rounded bg-gray-50 text-sm">
                    <option value="Food/Water">üçû Need Food / Water</option>
                    <option value="Shelter">‚õ∫ Need Shelter</option>
                    <option value="Transport">üöó Need Transport</option>
                    <option value="Medical Supplies">üíä Need Medical Supplies</option>
                    <option value="Other">‚ùì Other</option>
                </select>
                <input type="number" id="req-qty" placeholder="Quantity Needed (e.g. 5)" min="1"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                <textarea id="req-desc" placeholder="Details (e.g., 3 people, baby formula needed)"
                    class="w-full p-2 border rounded bg-gray-50 text-sm h-20" required></textarea>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('volunteer-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 rounded font-bold text-sm">Cancel</button>
                    <button type="submit"
                        class="flex-1 bg-teal-600 text-white py-2 rounded font-bold text-sm shadow">Post
                        Request</button>
                </div>
            </form>

            <!-- Join Volunteer Form -->
            <form id="form-join" onsubmit="submitVolunteer(event, 'join')" class="hidden space-y-3">
                <div class="p-3 bg-blue-50 rounded border border-blue-100 text-xs text-blue-800 mb-2">
                    Register as a volunteer to help others in your area.
                </div>
                <input type="text" id="vol-name" placeholder="Your Name"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                <input type="file" id="vol-photo" accept="image/*" class="w-full p-2 border rounded bg-gray-50 text-sm">
                <select id="vol-skill" class="w-full p-2 border rounded bg-gray-50 text-sm">
                    <option value="General">General Assistance</option>
                    <option value="First Aid">First Aid / Medical</option>
                    <option value="Search & Rescue">Search & Rescue</option>
                    <option value="Driver">Driver (Have Vehicle)</option>
                    <option value="Cook">Cooking / Food Dist.</option>
                </select>
                <input type="tel" id="vol-contact" placeholder="Contact Number"
                    class="w-full p-2 border rounded bg-gray-50 text-sm" required>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('volunteer-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 rounded font-bold text-sm">Cancel</button>
                    <button type="submit"
                        class="flex-1 bg-blue-600 text-white py-2 rounded font-bold text-sm shadow">Register</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CHECKLIST MODAL -->
    <div id="checklist-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-fade-in">
            <h2 class="text-xl font-bold mb-4">üéí Preparedness Checklist</h2>
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 accent-blue-600">
                    <span class="text-sm">Pack Go-Bag (Water, Meds)</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 accent-blue-600">
                    <span class="text-sm">Save Emergency Numbers</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 accent-blue-600">
                    <span class="text-sm">Identify Meeting Point</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 accent-blue-600">
                    <span class="text-sm">Download Offline Maps</span>
                </label>
            </div>
            <button onclick="document.getElementById('checklist-modal').classList.add('hidden')"
                class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold">Close</button>
        </div>
    </div>

    <!-- SCANNER MODAL -->
    <div id="scanner-modal"
        class="hidden fixed inset-0 z-[1600] bg-black/80 flex items-center justify-center p-4 backdrop-blur-md">
        <div
            class="bg-gray-900 w-full max-w-lg rounded-xl p-4 shadow-2xl border border-pink-500 relative flex flex-col items-center">

            <button onclick="closeScannerModal()" class="absolute top-2 right-2 text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>

            <h2 class="text-xl font-bold text-pink-500 mb-2"><i class="fas fa-expand"></i> Face Scanner</h2>
            <p class="text-xs text-gray-400 mb-4 text-center">Point camera at people to check against missing reports.
            </p>

            <div class="relative w-full aspect-video bg-black rounded overflow-hidden border border-gray-700">
                <video id="scanner-video" class="w-full h-full object-cover" autoplay muted></video>
                <canvas id="scanner-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>

                <div id="scan-status"
                    class="absolute bottom-2 left-2 px-2 py-1 bg-black/60 text-white text-[10px] rounded font-mono">
                    Initializing...
                </div>
            </div>

            <div class="mt-4 flex gap-3 w-full">
                <button onclick="toggleScanner(true)" id="btn-start-scan"
                    class="flex-1 bg-pink-600 hover:bg-pink-500 text-white py-2 rounded font-bold text-sm">
                    <i class="fas fa-play"></i> Start
                </button>
                <button onclick="toggleScanner(false)" id="btn-stop-scan"
                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-300 py-2 rounded font-bold text-sm hidden">
                    <i class="fas fa-stop"></i> Stop
                </button>
                <button onclick="flipCamera()" id="btn-flip-cam"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded font-bold text-sm"
                    title="Flip Camera">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>

            <!-- RESULT AREA -->
            <div id="scan-result"
                class="hidden mt-3 w-full bg-green-900/30 border border-green-500 p-3 rounded flex items-center gap-3 animate-pulse">
                <img id="match-img" src="" class="w-12 h-12 rounded object-cover border border-green-400">
                <div>
                    <div class="text-green-400 font-bold text-sm">MATCH FOUND!</div>
                    <div id="match-name" class="text-white text-xs">Name: Unknown</div>
                </div>
                <button onclick="notifyMatch()"
                    class="ml-auto bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">
                    NOTIFY
                </button>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                app_name: "SARAL (Smart Alert & Resilient Aid Layer)",
                app_tagline: "Smart Alert & Resilient Aid Layer",
                status_safe: "STATUS: SAFE",
                conn_mode: "Connection Mode",
                conn_online: "Online (Internet)",
                conn_mesh: "Mesh Radio (Offline)",
                sos_title: "SOS",
                sos_desc: "Broadcast Emergency Signal",
                triage_title: "Health Triage",
                btn_minor: "Minor",
                btn_moderate: "Moderate",
                btn_critical: "Critical",
                checklist_title: "Preparedness Checklist",
                checklist_desc: "Are you ready?",
                safe_route_title: "Safe Route",
                gps_active: "GPS Active",
                nav_btn: "NAVIGATE TO SAFE ZONE",
                sos_full_title: "SOS EMERGENCY",
                sos_full_desc: "Broadcast Distress Signal",
                btn_damage: "Report Damage",
                btn_missing: "Find People",
                btn_volunteer: "Volunteer"
            },
            hi: {
                app_name: "‡§∏‡§∞‡§≤",
                app_tagline: "‡§Ü‡§™‡§¶‡§æ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§Æ‡§Ç‡§ö",
                status_safe: "‡§∏‡•ç‡§•‡§ø‡§§‡§ø: ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§",
                conn_mode: "‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•ã‡§°",
                conn_online: "‡§ë‡§®‡§≤‡§æ‡§á‡§® (‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü)",
                conn_mesh: "‡§Æ‡•á‡§∂ ‡§∞‡•á‡§°‡§ø‡§Ø‡•ã (‡§ë‡§´‡§≤‡§æ‡§á‡§®)",
                sos_title: "‡§¨‡§ö‡§æ‡§ì (SOS)",
                sos_desc: "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§≠‡•á‡§ú‡•á‡§Ç",
                triage_title: "‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
                btn_minor: "‡§Æ‡§æ‡§Æ‡•Ç‡§≤‡•Ä",
                btn_moderate: "‡§Æ‡§ß‡•ç‡§Ø‡§Æ",
                btn_critical: "‡§ó‡§Ç‡§≠‡•Ä‡§∞",
                checklist_title: "‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä",
                checklist_desc: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à‡§Ç?",
                safe_route_title: "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§æ‡§∏‡•ç‡§§‡§æ",
                gps_active: "‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø",
                nav_btn: "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ï‡•Ä ‡§ì‡§∞ ‡§ú‡§æ‡§è‡§Ç",
                sos_full_title: "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® SOS",
                sos_full_desc: "‡§∏‡§Ç‡§ï‡§ü ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§™‡•ç‡§∞‡§∏‡§æ‡§∞‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
                btn_damage: "‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç",
                btn_missing: "‡§≤‡§æ‡§™‡§§‡§æ ‡§≤‡•ã‡§ó ‡§ñ‡•ã‡§ú‡•á‡§Ç",
                btn_volunteer: "‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§ï ‡§¨‡§®‡•á‡§Ç"
            },
            mr: {
                app_name: "‡§∏‡§∞‡§≤",
                app_tagline: "‡§Ü‡§™‡§§‡•ç‡§§‡•Ä ‡§Æ‡§¶‡§§ ‡§Æ‡§Ç‡§ö",
                status_safe: "‡§∏‡•ç‡§•‡§ø‡§§‡•Ä: ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§",
                conn_mode: "‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•ã‡§°",
                conn_online: "‡§ë‡§®‡§≤‡§æ‡§á‡§® (‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü)",
                conn_mesh: "‡§Æ‡•á‡§∂ ‡§∞‡•á‡§°‡§ø‡§ì (‡§ë‡§´‡§≤‡§æ‡§á‡§®)",
                sos_title: "‡§µ‡§æ‡§ö‡§µ‡§æ (SOS)",
                sos_desc: "‡§Ü‡§£‡•Ä‡§¨‡§æ‡§£‡•Ä ‡§∏‡§ø‡§ó‡•ç‡§®‡§≤ ‡§™‡§æ‡§†‡§µ‡§æ",
                triage_title: "‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä",
                btn_minor: "‡§ï‡§ø‡§∞‡§ï‡•ã‡§≥",
                btn_moderate: "‡§Æ‡§ß‡•ç‡§Ø‡§Æ",
                btn_critical: "‡§ó‡§Ç‡§≠‡•Ä‡§∞",
                checklist_title: "‡§§‡§Ø‡§æ‡§∞‡•Ä ‡§Ø‡§æ‡§¶‡•Ä",
                checklist_desc: "‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§§‡§Ø‡§æ‡§∞ ‡§Ü‡§π‡§æ‡§§ ‡§ï‡§æ?",
                safe_route_title: "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§Æ‡§æ‡§∞‡•ç‡§ó",
                gps_active: "‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø",
                nav_btn: "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§æ‡§ï‡§°‡•á ‡§ú‡§æ",
                sos_full_title: "‡§Ü‡§£‡•Ä‡§¨‡§æ‡§£‡•Ä SOS",
                sos_full_desc: "‡§∏‡§Ç‡§ï‡§ü ‡§∏‡§ø‡§ó‡•ç‡§®‡§≤ ‡§™‡•ç‡§∞‡§∏‡§æ‡§∞‡§ø‡§§ ‡§ï‡§∞‡§æ",
                btn_damage: "‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ï‡§≥‡§µ‡§æ",
                btn_missing: "‡§π‡§∞‡§µ‡§≤‡•á‡§≤‡•Ä ‡§Æ‡§æ‡§£‡§∏‡•á ‡§∂‡•ã‡§ß‡§æ",
                btn_volunteer: "‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§ï ‡§¨‡§®‡§æ"
            },
            bn: {
                app_name: "‡¶∏‡¶∞‡¶≤",
                app_tagline: "‡¶¶‡ßÅ‡¶∞‡ßç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ",
                status_safe: "‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ: ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶",
                conn_mode: "‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶Æ‡ßã‡¶°",
                conn_online: "‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® (‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü)",
                conn_mesh: "‡¶Æ‡ßá‡¶∂ ‡¶∞‡ßá‡¶°‡¶ø‡¶ì (‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®)",
                sos_title: "‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶® (SOS)",
                sos_desc: "‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶∏‡¶Ç‡¶ï‡ßá‡¶§ ‡¶™‡¶æ‡¶†‡¶æ‡¶®",
                triage_title: "‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ",
                btn_minor: "‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø",
                btn_moderate: "‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø",
                btn_critical: "‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡¶∞",
                checklist_title: "‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ",
                checklist_desc: "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§?",
                safe_route_title: "‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶∞‡ßÅ‡¶ü",
                gps_active: "‡¶ú‡¶ø‡¶™‡¶ø‡¶è‡¶∏ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º",
                nav_btn: "‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶ú‡ßã‡¶®‡ßá ‡¶Ø‡¶æ‡¶®",
                sos_full_title: "‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ SOS",
                sos_full_desc: "‡¶¨‡¶ø‡¶™‡¶¶ ‡¶∏‡¶Ç‡¶ï‡ßá‡¶§ ‡¶™‡ßç‡¶∞‡¶ö‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®",
                btn_damage: "‡¶ï‡ßç‡¶∑‡¶Ø‡¶º‡¶ï‡ßç‡¶∑‡¶§‡¶ø‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®",
                btn_missing: "‡¶®‡¶ø‡¶ñ‡ßã‡¶Å‡¶ú ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®",
                btn_volunteer: "‡¶∏‡ßç‡¶¨‡ßá‡¶ö‡ßç‡¶õ‡¶æ‡¶∏‡ßá‡¶¨‡¶ï ‡¶π‡¶®"
            }
        };

        function changeLanguage(lang) {
            const t = translations[lang];
            if (!t) return;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if (el.tagName === 'INPUT' && el.type === 'placeholder') {
                        el.placeholder = t[key];
                    } else {
                        el.innerText = t[key];
                    }
                }
            });
        }
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        // Emit 'identify' event to tell server we are a USER, mostly for debugging
        socket.emit('identify', { type: 'USER' });

        const channel = {
            postMessage: (data) => {
                socket.emit(data.type, data);
            },
            onmessage: null
        };
        const events = ['LOCATION_UPDATE', 'SOS', 'TRIAGE_REPORT', 'RESOURCE_UPDATE', 'DISASTER_ALERT', 'DISASTER_CLEAR', 'MEDICAL_REPORT', 'HELP_REQUEST', 'VOLUNTEER_JOIN', 'FOUND_PERSON', 'MISSING_PERSON', 'DAMAGE_REPORT'];
        events.forEach(event => {
            socket.on(event, (data) => {
                if (channel.onmessage) {
                    channel.onmessage({ data: data });
                }
            });
        });

        // Listen for Help Acknowledgement
        socket.on('SOS_ACKNOWLEDGE', (data) => {
            if (data.userId === USER_ID) {
                // Show Alert
                alert("üö® HELP IS ON THE WAY!\n\nControl Room has received your SOS and dispatched a team.");

                // Update UI (Optional: Change SOS button text?)
                const sosBtn = document.querySelector('button[onclick="sendSOS()"]');
                if (sosBtn) {
                    sosBtn.innerHTML = '<h2 class="text-xl font-black">HELP SENT</h2><p class="text-xs text-green-100">Rescue Team Inbound</p>';
                    sosBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    sosBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'animate-pulse');
                }
            }
        });

        socket.on('SOS_RESOLVE', (data) => {
            if (data.userId === USER_ID) {
                alert("‚úÖ INCIDENT RESOLVED\n\nControl Room has marked your emergency as resolved.");
                // Reset UI
                location.reload();
            }
        });
        // PERSIST USER ID to prevent duplicate markers on refresh
        let savedId = localStorage.getItem('saral_user_id');
        if (!savedId) {
            const randomNum = Math.floor(Math.random() * 10000);
            savedId = 'CITIZEN-' + randomNum;
            localStorage.setItem('saral_user_id', savedId);
        }
        const USER_ID = savedId;
        document.getElementById('user-id-display').innerText = `ID: ${USER_ID}`;

        let map;

        // --- MESH MODE TOGGLE ---
        function toggleMeshMode(checkbox) {
            const status = document.getElementById('mesh-status');
            const icon = document.getElementById('mesh-icon');

            if (checkbox.checked) {
                status.innerText = "Mesh Radio (Offline)";
                status.classList.add('text-blue-600', 'font-bold');
                icon.innerHTML = '<i class="fas fa-project-diagram text-blue-600"></i>';
                alert("üì° Switched to Mesh Mode. You can now communicate without Internet.");
            } else {
                status.innerText = "Online (Internet)";
                status.classList.remove('text-blue-600', 'font-bold');
                icon.innerHTML = '<i class="fas fa-wifi"></i>';
            }
        }

        // --- MAP & LOCATION ---
        let startLoc = [28.6139, 77.2090]; // Default: New Delhi (Fallback)
        let userMarker;
        let routeLayer;

        window.addEventListener('load', () => {
            map = L.map('map').setView(startLoc, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // Try to get real location
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const accuracy = position.coords.accuracy;
                        let lat = position.coords.latitude;
                        let lng = position.coords.longitude;
                        let isSnapping = false;

                        // ACCURACY CHECK: If error > 5km, snap to Nirjuli (User's known location)
                        // This fixes the "Imphal" IP-based geolocation error.
                        if (accuracy > 5000) {
                            lat = 27.1287;
                            lng = 93.7380;
                            isSnapping = true;
                        }

                        startLoc = [lat, lng];

                        // Update User Marker
                        const popupContent = isSnapping
                            ? `<strong>Signal Weak (${Math.round(accuracy)}m)</strong><br>Snapped to: Nirjuli`
                            : `Location: ${lat.toFixed(5)}, ${lng.toFixed(5)}<br>Accuracy: ${accuracy.toFixed(1)}m`;

                        if (userMarker) {
                            userMarker.setLatLng(startLoc);
                            userMarker.setPopupContent(popupContent);
                        } else {
                            userMarker = L.marker(startLoc).addTo(map)
                                .bindPopup(popupContent)
                                .openPopup();
                            map.setView(startLoc, 15);
                        }

                        // Send Heartbeat IMMEDIATELY
                        sendHeartbeat();
                    },
                    (error) => {
                        console.error("Geolocation denied/error:", error);
                        // Fallback
                        if (!userMarker) {
                            alert("Location failed. Using simulation default.");
                            userMarker = L.marker(startLoc).addTo(map).bindPopup("Simulation Location").openPopup();
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                alert("Geolocation not supported. Using simulation.");
                userMarker = L.marker(startLoc).addTo(map).bindPopup("Simulation Location").openPopup();
            }

            setInterval(sendHeartbeat, 5000);
        });

        function sendHeartbeat() {
            // Send EXACT location, NO JITTER
            const locationString = `${startLoc[0]}, ${startLoc[1]}`;

            channel.postMessage({
                userId: USER_ID,
                type: 'LOCATION_UPDATE',
                location: locationString,
                time: new Date().toLocaleTimeString()
            });
        }

        // --- ACTIONS ---
        function sendSOS() {
            if (confirm("Are you sure you want to send an SOS?")) {
                channel.postMessage({
                    userId: USER_ID,
                    type: 'SOS',
                    details: 'Emergency Button Pressed',
                    location: `${startLoc[0]}, ${startLoc[1]}`,
                    time: new Date().toLocaleTimeString()
                });
                alert("SOS SENT! Help is on the way.");
                document.getElementById('status-banner').className = "bg-red-600 text-white p-3 text-center font-bold text-sm shadow-md animate-pulse";
                document.getElementById('status-banner').innerHTML = '<i class="fas fa-exclamation-triangle"></i> STATUS: SOS ACTIVE';
            }
        }

        function reportHealth(severity) {
            document.getElementById('medical-modal').classList.remove('hidden');
            document.getElementById('med-severity').value = severity;

            const display = document.getElementById('med-severity-display');
            display.innerText = severity;

            if (severity === 'Critical') display.className = "font-black text-lg uppercase text-red-600";
            else if (severity === 'Moderate') display.className = "font-black text-lg uppercase text-yellow-600";
            else display.className = "font-black text-lg uppercase text-green-600";
        }

        function submitMedicalReport(e) {
            e.preventDefault();
            const severity = document.getElementById('med-severity').value;
            const type = document.getElementById('med-type').value;
            const isUnconscious = document.getElementById('med-conscious').checked;

            let details = `[${severity}] ${type}`;
            if (isUnconscious) details += " (UNCONSCIOUS)";

            channel.postMessage({
                userId: USER_ID,
                type: 'MEDICAL_REPORT',
                severity: severity.toLowerCase(), // critical, moderate, minor
                details: details,
                location: `${startLoc[0]}, ${startLoc[1]}`,
                time: new Date().toLocaleTimeString()
            });

            alert(`Medical Alert Sent! Help is coming.`);
            document.getElementById('medical-modal').classList.add('hidden');
            e.target.reset();
        }

        async function findSafeZone() {
            // STAMPEDE PREVENTION LOGIC: Different Destinations for Crowd Control
            const idNum = parseInt(USER_ID.replace(/\D/g, '')) || 0;
            const isEven = idNum % 2 === 0;

            // Define two slightly different "Safe Zones" to split the crowd
            // In a real scenario, these would be two different entry gates or shelters.
            const safeLatA = startLoc[0] + 0.015;
            const safeLngA = startLoc[1] + 0.015;
            const safeLocA = [safeLatA, safeLngA];

            const safeLatB = startLoc[0] + 0.015; // Same Lat
            const safeLngB = startLoc[1] - 0.015; // OPPOSITE Lng (West instead of East)
            const safeLocB = [safeLatB, safeLngB];

            let targetLoc, zoneName, routeColor;

            if (isEven) {
                targetLoc = safeLocA;
                zoneName = "Safe Zone A (Primary)";
                routeColor = '#2563eb'; // Blue
            } else {
                targetLoc = safeLocB;
                zoneName = "Safe Zone B (Secondary)";
                routeColor = '#9333ea'; // Purple
            }

            // Remove previous route
            if (routeLayer) map.removeLayer(routeLayer);

            // Add Markers for BOTH zones to show options
            L.marker(safeLocA, { icon: L.divIcon({ className: 'text-2xl', html: 'üè•' }) }).addTo(map).bindPopup("Safe Zone A").openPopup();
            L.marker(safeLocB, { icon: L.divIcon({ className: 'text-2xl', html: '‚õ∫' }) }).addTo(map).bindPopup("Safe Zone B");

            // Fetch Route to the ASSIGNED target
            const url = `https://router.project-osrm.org/route/v1/driving/${startLoc[1]},${startLoc[0]};${targetLoc[1]},${targetLoc[0]}?overview=full&geometries=geojson`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.code === 'Ok') {
                    const routeGeoJSON = data.routes[0].geometry;

                    routeLayer = L.geoJSON(routeGeoJSON, {
                        style: { color: routeColor, weight: 6, opacity: 0.8 }
                    }).addTo(map);

                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

                    alert(`üõ° STAMPEDE PREVENTION ACTIVE\n\nüë§ User ID: ${USER_ID} (${isEven ? 'Even' : 'Odd'})\nüìç Assigned: ${zoneName}\n‚úÖ Path: Optimized to reduce congestion.`);
                } else {
                    throw new Error("No route found");
                }
            } catch (error) {
                console.error("Routing Error:", error);
                // Fallback
                routeLayer = L.polyline([startLoc, targetLoc], { color: 'red', weight: 2, dashArray: '5,5' }).addTo(map);
                map.fitBounds([startLoc, targetLoc]);
                alert("Offline Mode: Showing straight line direction.");
            }
        }

        // --- NEW FEATURES LOGIC ---
        function submitDamageReport(e) {
            e.preventDefault();
            const type = document.getElementById('damage-type').value;
            const desc = document.getElementById('damage-desc').value;

            channel.postMessage({
                userId: USER_ID,
                type: 'DAMAGE_REPORT',
                details: `${type}: ${desc}`,
                location: `${startLoc[0]}, ${startLoc[1]}`,
                time: new Date().toLocaleTimeString()
            });

            alert("Damage Report Submitted. Authorities Notified.");
            document.getElementById('damage-modal').classList.add('hidden');
            e.target.reset();
        }

        function toggleLostTab(tab) {
            if (tab === 'person') {
                document.getElementById('form-person').classList.remove('hidden');
                document.getElementById('form-item').classList.add('hidden');
                document.getElementById('tab-person').className = "px-3 py-1 rounded bg-purple-600 text-white text-xs font-bold transition";
                document.getElementById('tab-item').className = "px-3 py-1 rounded text-gray-500 text-xs font-bold transition hover:bg-gray-200";
            } else {
                document.getElementById('form-person').classList.add('hidden');
                document.getElementById('form-item').classList.remove('hidden');
                document.getElementById('tab-item').className = "px-3 py-1 rounded bg-gray-700 text-white text-xs font-bold transition";
                document.getElementById('tab-person').className = "px-3 py-1 rounded text-gray-500 text-xs font-bold transition hover:bg-gray-200";
            }
        }

        function submitLostReport(e, category) {
            e.preventDefault();
            let details = "";
            let type = "";
            let imageFile = null;

            if (category === 'person') {
                type = "MISSING_PERSON";
                const name = document.getElementById('p-name').value;
                const age = document.getElementById('p-age').value;
                const contact = document.getElementById('p-contact').value;
                imageFile = document.getElementById('p-image').files[0];
                details = `Missing: ${name} (${age}y) | Contact: ${contact}`;
            } else {
                type = "LOST_ITEM";
                const item = document.getElementById('i-type').value;
                const desc = document.getElementById('i-desc').value;
                const contact = document.getElementById('i-contact').value;
                details = `Lost: ${item} - ${desc} | Contact: ${contact}`;
            }

            const sendMsg = (imgBase64 = null) => {
                const msgData = {
                    userId: USER_ID,
                    type: type,
                    details: details,
                    image: imgBase64,
                    location: `${startLoc[0]}, ${startLoc[1]}`,
                    time: new Date().toLocaleTimeString()
                };

                // Broadcast to others
                channel.postMessage(msgData);

                // Save locally for SELF (Sender) so I can scan immediately
                if (type === 'MISSING_PERSON' && imgBase64) {
                    saveMissingPerson(msgData);
                }

                alert("Report Submitted Successfully.");
                document.getElementById('lost-modal').classList.add('hidden');
                e.target.reset();
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onloadend = function () {
                    sendMsg(reader.result);
                }
                reader.readAsDataURL(imageFile);
            } else {
                sendMsg();
            }
        }

        // --- VOLUNTEER LOGIC ---
        function toggleVolTab(tab) {
            if (tab === 'request') {
                document.getElementById('form-request').classList.remove('hidden');
                document.getElementById('form-join').classList.add('hidden');
                document.getElementById('tab-request').className = "px-3 py-1 rounded bg-teal-600 text-white text-xs font-bold transition";
                document.getElementById('tab-join').className = "px-3 py-1 rounded text-gray-500 text-xs font-bold transition hover:bg-gray-200";
            } else {
                document.getElementById('form-request').classList.add('hidden');
                document.getElementById('form-join').classList.remove('hidden');
                document.getElementById('tab-join').className = "px-3 py-1 rounded bg-blue-600 text-white text-xs font-bold transition";
                document.getElementById('tab-request').className = "px-3 py-1 rounded text-gray-500 text-xs font-bold transition hover:bg-gray-200";
            }
        }

        function submitVolunteer(e, category) {
            e.preventDefault();
            let type = "";
            let details = "";
            let quantity = 0;
            let imageFile = null;

            if (category === 'request') {
                type = "HELP_REQUEST";
                const reqType = document.getElementById('req-type').value;
                const desc = document.getElementById('req-desc').value;
                const qtyInput = document.getElementById('req-qty').value;
                quantity = parseInt(qtyInput) || 1;
                details = `Request: ${quantity}x ${reqType} - ${desc}`;
            } else {
                type = "VOLUNTEER_JOIN";
                const name = document.getElementById('vol-name').value;
                const skill = document.getElementById('vol-skill').value;
                const contact = document.getElementById('vol-contact').value;
                imageFile = document.getElementById('vol-photo').files[0];
                details = `Volunteer: ${name} (${skill}) | Contact: ${contact}`;
            }

            const sendVolMsg = (imgBase64 = null) => {
                channel.postMessage({
                    userId: USER_ID,
                    type: type,
                    details: details,
                    quantity: quantity,
                    image: imgBase64,
                    location: `${startLoc[0]}, ${startLoc[1]}`,
                    time: new Date().toLocaleTimeString()
                });

                alert(category === 'request' ? "Help Request Posted!" : "Registered as Volunteer!");
                document.getElementById('volunteer-modal').classList.add('hidden');
                e.target.reset();
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onloadend = function () {
                    sendVolMsg(reader.result);
                }
                reader.readAsDataURL(imageFile);
            } else {
                sendVolMsg();
            }
        }

        // --- ALERTS ---
        function dismissUserAlert() {
            document.getElementById('user-disaster-alert').classList.add('hidden');
        }

        channel.onmessage = (event) => {
            const data = event.data;
            if (data.type === 'DISASTER_ALERT') {
                const alertBox = document.getElementById('user-disaster-alert');
                document.getElementById('user-alert-type').innerText = data.alertType + " ALERT";
                document.getElementById('user-alert-msg').innerText = `DANGER in ${data.zone}. Evacuate immediately!`;
                alertBox.classList.remove('hidden');

                document.getElementById('status-banner').className = "bg-red-600 text-white p-3 text-center font-bold text-sm shadow-md animate-pulse";
                document.getElementById('status-banner').innerHTML = '<i class="fas fa-exclamation-triangle"></i> STATUS: DANGER';
            }
            if (data.type === 'DISASTER_CLEAR') {
                document.getElementById('user-disaster-alert').classList.add('hidden');
                document.getElementById('status-banner').className = "bg-green-600 text-white p-3 text-center font-bold text-sm shadow-md";
                document.getElementById('status-banner').innerHTML = '<i class="fas fa-check-circle"></i> STATUS: SAFE';
                alert("‚úÖ Area is now safe.");
            }

            // --- C. FOUND PERSON ALERT ---
            if (data.type === 'FOUND_PERSON' && data.targetId === USER_ID) {
                // If I am the person who reported it (USER_ID matches targetId)
                alert(`üéâ GOOD NEWS!\n\nA Match has been found for your missing person report!\n\nMatched Location: ${data.location}\nTime: ${data.time}`);
            }

            // --- D. SYNC MISSING PERSONS ---
            if (data.type === 'MISSING_PERSON' && data.image) {
                // Save to local storage for matching
                saveMissingPerson(data);
            }
        };

        // --- FACE RECOGNITION LOGIC ---

        // 1. STATE
        let isModelLoaded = false;
        let isScanning = false;
        let scannerInterval = null;
        let currentMatch = null;

        // Load persisted data
        let knownFaces = JSON.parse(localStorage.getItem('saral_missing_faces') || '[]');

        function saveMissingPerson(data) {
            // Avoid duplicates
            if (!knownFaces.find(f => f.userId === data.userId && f.details === data.details)) {
                knownFaces.push(data);
                localStorage.setItem('saral_missing_faces', JSON.stringify(knownFaces));
                console.log("Stored new missing person for tracking:", data.details);
            }
        }

        // 2. MODEL LOADING
        async function loadFaceModels() {
            if (isModelLoaded) return;
            const status = document.getElementById('scan-status');
            status.innerText = "Loading AI Models...";

            try {
                // Load from generic CDN
                const MODEL_URL = 'https://vladmandic.github.io/face-api/model/';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);

                isModelLoaded = true;
                status.innerText = "AI Ready. Starting Camera...";
                console.log("FaceAPI Models Loaded");
            } catch (e) {
                console.error("Model Load Failed:", e);
                status.innerText = "Error Loading AI";
                alert("Failed to load AI models. Check internet connection.");
            }
        }

        // 3. UI HANDLERS
        async function openScannerModal() {
            document.getElementById('scanner-modal').classList.remove('hidden');
            await loadFaceModels();
            if (isModelLoaded) {
                toggleScanner(true);
            }
        }

        function closeScannerModal() {
            toggleScanner(false);
            document.getElementById('scanner-modal').classList.add('hidden');
            document.getElementById('scan-result').classList.add('hidden');
        }

        // 3. SCAN FACE CAMERA
        let currentFacingMode = 'environment'; // Default: Rear

        async function flipCamera() {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            // Visual feedback
            const btn = document.getElementById('btn-flip-cam');
            btn.classList.add('animate-spin');
            setTimeout(() => btn.classList.remove('animate-spin'), 500);

            if (isScanning) {
                // Restart with new mode
                await toggleScanner(false);
                setTimeout(() => toggleScanner(true), 500);
            }
        }

        async function toggleScanner(on) {
            const video = document.getElementById('scanner-video');
            const btnStart = document.getElementById('btn-start-scan');
            const btnStop = document.getElementById('btn-stop-scan');
            const status = document.getElementById('scan-status');

            if (on) {
                isScanning = true;
                btnStart.classList.add('hidden');
                btnStop.classList.remove('hidden');
                status.innerText = "Accessing Camera...";

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: currentFacingMode }
                    });
                    video.srcObject = stream;

                    video.onloadedmetadata = () => {
                        status.innerText = "Scanning...";
                        startDetectionLoop();
                    };
                } catch (err) {
                    console.error("Camera Error:", err);
                    status.innerText = `Error: ${err.name}`;
                    alert(`Camera Error: ${err.name}\n${err.message}\n\nTrace: ${err.stack || 'No stack'}`);

                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        alert("Permission explicitly denied. Please reset permissions in your browser address bar.");
                    } else if (err.name === 'NotFoundError') {
                        alert("No camera device found.");
                    } else if (err.name === 'NotReadableError') {
                        alert("Camera is maybe in use by another app.");
                    } else if (location.protocol === 'file:') {
                        alert("NOTE: Some browsers block camera on 'file://' URLs. Please try running this via a local server (http://localhost) or use Firefox.");
                    }
                }
            } else {
                isScanning = false;
                btnStart.classList.remove('hidden');
                btnStop.classList.add('hidden');
                status.innerText = "Stopped";

                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                clearInterval(scannerInterval);

                // Clear Canvas
                const canvas = document.getElementById('scanner-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // 4. DETECTION LOOP
        async function startDetectionLoop() {
            const video = document.getElementById('scanner-video');
            const canvas = document.getElementById('scanner-canvas');

            // Match canvas size to video
            faceapi.matchDimensions(canvas, { width: video.clientWidth, height: video.clientHeight });

            // Prepare Labeled Descriptors from Stored Data
            // Note: This is computationally expensive relative to size, do once if possible or lazy load
            // For prototype, we do it on the fly or pre-calc

            const labeledDescriptors = [];
            const infoStatus = document.getElementById('scan-status');
            infoStatus.innerText = `Processing ${knownFaces.length} ref faces...`;
            console.log(`[Scan] Processing ${knownFaces.length} potential missing persons.`);

            for (const person of knownFaces) {
                if (!person.image) {
                    console.warn(`[Scan] Person ${person.userId} has no image.`);
                    continue;
                }

                try {
                    // Create an invisible image element
                    const img = document.createElement('img');
                    img.src = person.image;
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                    });

                    // 1. Try Default High-Accuracy Detector (SSD MobileNet V1)
                    let detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();

                    // 2. Fallback to TinyFaceDetector if SSD fails (sometimes works better on smaller/grainy images)
                    if (!detection) {
                        console.log(`[Scan] SSD failed for ${person.details}, trying TinyFace...`);
                        detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    }

                    if (detection) {
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(
                            person.userId + "||" + person.details,
                            [detection.descriptor]
                        ));
                        console.log(`[Scan] Successfully indexed face for: ${person.details}`);
                    } else {
                        console.warn(`[Scan] COULD NOT DETECT FACE in image for: ${person.details}`);
                        // Optional: Alert user briefly?
                    }
                } catch (e) {
                    console.error("[Scan] Error processing image:", e);
                }
            }

            if (labeledDescriptors.length === 0) {
                document.getElementById('scan-status').innerText = "No missing reports to match against.";
                return; // Nothing to match
            }

            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
            document.getElementById('scan-status').innerText = "Scanning Active...";

            scannerInterval = setInterval(async () => {
                if (!isScanning) return;

                // Detect faces in video
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();

                // Resize
                const resizedDetections = faceapi.resizeResults(detections, { width: video.clientWidth, height: video.clientHeight });

                // Draw
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, resizedDetections);

                // Match
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
                    drawBox.draw(canvas);

                    // Check for match
                    if (result.label !== 'unknown') {
                        // FOUND ONE!
                        handleMatchFound(result.label);
                    }
                });

            }, 500); // Check every 500ms
        }

        function handleMatchFound(label) {
            // Debounce or just show UI
            const [userId, details] = label.split('||'); // Format we stored

            // Show result UI
            const resultDiv = document.getElementById('scan-result');
            const matchName = document.getElementById('match-name');
            const matchImg = document.getElementById('match-img');

            resultDiv.classList.remove('hidden');
            matchName.innerText = details;

            // Find original image
            const original = knownFaces.find(f => f.userId === userId && f.details === details);
            if (original) matchImg.src = original.image;

            currentMatch = {
                targetId: userId,
                details: details,
                // The finder's current location
                location: `${startLoc[0]}, ${startLoc[1]}`
            };
        }

        function notifyMatch() {
            if (!currentMatch) return;

            channel.postMessage({
                type: 'FOUND_PERSON',
                targetId: currentMatch.targetId,
                details: currentMatch.details,
                location: currentMatch.location,
                time: new Date().toLocaleTimeString(),
                finderId: USER_ID
            });

            alert("Owner Notified! Thank you for your help.");
            closeScannerModal();
        }
    </script>
</body>

</html>